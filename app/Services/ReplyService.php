<?php

namespace App\Services;

use App\Http\Conversations\CreateOrderConversation;
use App\Http\Conversations\PaymentConversation;
use BotMan\BotMan\BotMan;
use BotMan\Drivers\Telegram\TelegramDriver;
use Illuminate\Support\Facades\Log;

class ReplyService
{
    public $botName;
    public $service;
    public $keyboardService;
    public $ordersService;

    public $mainKeyboard;
    public $cancelKeyboard;
    public $ordersKeyboardDone;
    public $ordersKeyboardActive;
    public $subscribeKeyboard;

    public function __construct()
    {
        $this->botName = config('botman.telegram')['botname'];

        $this->service         = new BotmanService();
        $this->keyboardService = new KeyboardService();
        $this->ordersService   = new OrdersService();

        $this->subscribeKeyboard = $this->keyboardService->getSubscribeKeyboard();
        $this->mainKeyboard      = $this->keyboardService->getMainKeyboard();
        $this->cancelKeyboard    = $this->keyboardService->getCancelKeyboard();
        $this->ordersKeyboardActive = $this->keyboardService->getOrdersKeyboard('active');
        $this->ordersKeyboardDone   = $this->keyboardService->getOrdersKeyboard('done');
    }









    /**
     * ะกัะฐัั ะธ ะกัะฐัั + ัะตัะบะฐ
     * @param  BotMan $bot
     * @param bool $ref_id
     */
    public function handleStart($bot, $ref_id = false)
    {
        $user = $this->service->getOrRegisterUser($bot->getUser(), $ref_id);
        //$isSubscribe = $this->service->checkSubscribe($bot->getUser()->getId());

        if ($user->wasRecentlyCreated) {
            $bot->reply(
                "๐ Welcome, iโm FLYSMM Bot with me you can improve your social media accounts. \r\n\r\n" .

                "It's very simple: \r\n" .
                "1๏ธโฃ Get new subscripbers \r\n" .
                "2๏ธโฃ Get likes, views, comments, etc\r\n" .

                "Add money to your balance and make first order. \r\n\r\n" .

                "All Social Medias.\r\n\r\n" .

                "Support: \r\n" .
                "@PeopleSupport",
                $this->mainKeyboard
            );

//            $bot->reply(
//                "Add money to your balance and make first order! :)",
//                $this->mainKeyboard
//            );

//            if($isSubscribe) {
//            } else {
//                if(!$isSubscribe) $this->sendSubscribeMessage($bot);
//            }
        } else {
            $bot->reply(
                "๐ Welcome, iโm FLYSMM Bot with me you can improve your social media accounts. \r\n\r\n" .

                "It's very simple: \r\n" .
                "1๏ธโฃ Get new subscripbers \r\n" .
                "2๏ธโฃ Get likes, views, comments, etc\r\n" .

                "Add money to your balance and make first order. \r\n\r\n" .

                "All Social Medias.\r\n\r\n" .

                "Support: \r\n" .
                "@PeopleSupport",
                $this->mainKeyboard
            );

            //if(!$isSubscribe) $this->sendSubscribeMessage($bot);
        }
    }





    /**
     * ะัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธะต ะพ ะฝะตะพะฑัะพะดะธะผะพััะธ ะฟะพะดะฟะธัะบะธ ะฝะฐ ะบะฐะฝะฐะป
     * @param  BotMan $bot
     * @throws mixed
     */
    public function sendSubscribeMessage($bot)
    {
        $bot->reply(
            "ะะปั ะดะฐะปัะฝะตะนัะตะน ัะฐะฑะพัั ั ะฑะพัะพะผ - ะฒะฐะผ ะฝะตะพะฑัะพะดะธะผะพ ะฟะพะดะฟะธัะฐัััั ะฝะฐ ะบะฐะฝะฐะป",
            $this->subscribeKeyboard
        );
    }




    /**
     * ะะฐะถะฐัะธะต ะบะฝะพะฟะบะธ "ะัะพะฒะตัะธัั ะฟะพะดะฟะธัะบั" ะฟัะธ ะฟะตัะฒะพะผ ะบะพะฝัะฐะบัะต
     * @param  BotMan $bot
     * @throws mixed
     * @return mixed
     */
    public function handleCheckSubscribe($bot)
    {
        $parameters = array_merge([
            'chat_id' => $bot->getMessage()->getPayload()['chat']['id'],
            'message_id' => $bot->getMessage()->getPayload()['message_id'],
            'text' => '๐๐ผ Excellent! You can use the services of the bot! โคต๏ธ',
        ]);
        $bot->sendRequest('editMessageText', $parameters);

        $bot->reply(
            '๐ธ Before ordering the service - add money to your account ๐ธ',
            $this->mainKeyboard
        );
    }





    /**
     * ะะพะทะฒัะฐั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั
     * @param  BotMan $bot
     */
    public function handleBackToMainMenu($bot)
    {
        $bot->reply(
            "โข If bot does't respond - enter /restart" .
            "\r\n\r\n" .
            "๐ Select menu item:",
            $this->mainKeyboard);
    }





    /**
     * ะะตัะตะทะฐะณััะทะบะฐ ะฑะพัะฐ (/restart)
     * @param  BotMan $bot
     */
    public function handleRestart($bot)
    {
        $bot->reply(
            "Bot restarted โ",
            $this->mainKeyboard);
//        $isSubscribe = $this->service->checkSubscribe($bot->getUser()->getId());
//        if(!$isSubscribe) $this->sendSubscribeMessage($bot);
    }




    /**
     * ะัะฒะพะด ะณะปะฐะฒะฝะพะณะพ ะผะตะฝั
     * @param  BotMan $bot
     */
    public function handleMenu($bot)
    {
        $bot->reply("Main menu โ", $this->mainKeyboard);
    }





    /**
     * ะะพะดะดะตัะถะบะฐ
     * @param  BotMan $bot
     */
    public function handleSupport($bot)
    {
        $bot->reply(
            "Bot๐ค works as automatically as possible, 24/7/365, so feel free to use it! \r\n\r\n" .
            "But if something goes wrong, please contact our technical support right away.  \r\n".
            "Technical support @PeopleSupport ๐จ๐ป \r\n" .
            "9:00 AM to 11:00 PM",
            $this->mainKeyboard);
    }





    /**
     * ะกัะฐัะฐ ะฟะพ ัะตัะตัะฐะปะฐะผ
     * @param  BotMan $bot
     */
    public function handleRefStat($bot)
    {
        $referral_stat = $this->service->getReferralStat($bot->getUser()->getId());
        $bot->reply(
            "Attract new users and get 10% of their spending on services. \r\n" .
                        "FOREVER. \r\n\r\n" .
            "๐จ๐ปโ๐ป You have attracted " . $referral_stat['count'] . "  new users. \r\n\r\n" .
            "๐ฒ Earnings from referrals: " . $referral_stat['amount'] . " $.\r\n\r\n" .
            "Your referral link ๐๐ผ");

        $bot->reply("https://t.me/". $this->botName ."?start=" . $bot->getUser()->getId(),
            $this->mainKeyboard);
    }





    /**
     * ะะพะฟะพะปะฝะตะฝะธะต ะฑะฐะปะฐะฝัะฐ ะพั ะฐะดะผะธะฝะฐ - ัะทะตัะฐะผ
     * @param  BotMan $bot
     * @param $user_id
     * @param $amount
     * @throws mixed
     */
    public function handleAddFunds($bot, $user_id, $amount)
    {
        $result = $this->service->addFundsByAdmin($bot, $bot->getUser(), $user_id, $amount);
        if(isset($result['error'])) {
            $bot->reply($result['error']);
        } else {
            $bot->say($amount . ' $ credited to your account.', $user_id);
            $bot->reply('ะกัะตั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั ' . $user_id . ' ะฝะฐ ััะผะผั ' . $amount . '$. ะฑัะป ััะฟะตัะฝะพ ะฟะพะฟะพะปะฝะตะฝ.');
        }
    }

    /**
     * ะัะฟัะฐะฒะธั ะฟะพะปะพะถะธัะตะปัะฝัะน ะพัะฒะตั ะฝะฐ ะทะฐะฟัะพั ัะฐะทัะตัะตะฝะธั ะฟัะพะฒะตะดะตะฝะธั ะฟะปะฐัะตะถะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ
     * @param $bot
     * @param $invoice_id
     */
    public function invoiceConfirm($bot, $invoice_id)
    {
        try {
            $bot->sendRequest('answerPreCheckoutQuery', [
                'pre_checkout_query_id' => $invoice_id,
                'ok' => 'true',
            ]);
        } catch (\Throwable $e) {
            Log::error('invoiceConfirm error', ['err' => $e->getMessage()]);
        }
    }

    /**
     * ะะพะปะปะฑะตะบ ััะฟะตัะฝะพะณะพ ะฟะปะฐัะตะถะฐ
     * @param $bot
     * @param $invoiceData
     */
    public function paymentConfirmation($bot, $invoiceData)
    {
        try {
            $paymentService = (new PaymentsService())->callbackFromInvoice($invoiceData);
            $bot->reply($paymentService['amount'] . $paymentService['curr'] . ' credited to your account.',
                $this->mainKeyboard);

            $bot->say('ะกัะตั ะฟะพะปัะทะพะฒะฐัะตะปั '.$paymentService['chat_id'].' ะฟะพะฟะพะปะฝะตะฝ ะฝะฐ ' . $paymentService['amount'] . $paymentService['curr'], config('botman.telegram.notificationTelegramUserId'));
        } catch (\Throwable $e) {
            Log::error('ReplyService, paymentConfirmation', ['error' => $e->getMessage()]);
        }
    }





    /**
     * ะัะฒะพะด ะฑะฐะปะฐะฝัะฐ
     * @param  BotMan $bot
     */
    public function handleBalance($bot)
    {
        $balance = $this->service->getUserBalance($bot->getUser()->getId());
        $bot->reply(
            'Your Telegram ID: ' . $bot->getUser()->getId() . "\r\n\r\n" .
            '๐ฐ Your balance - ' . round($balance, 2) . ' USD',
            $this->mainKeyboard);
    }





    /**
     * ะะธะฐะปะพะณ ะฟะพะฟะพะปะฝะตะฝะธั ััะตัะฐ
     * @param  BotMan $bot
     */
    public function handlePayment($bot)
    {
        $this->startConversation($bot, new PaymentConversation($bot->getUser()->getId(), $bot->getUser()), '๐ณ Add Balance');
    }




    /**
     * ะัะฒะพะด ะบะฐัะตะณะพัะธะน ะดะปั ะทะฐะบะฐะทะฐ (ะฒัะฑะพั ัะพั ัะตัะธ)
     * @param  BotMan $bot
     */
    public function handleOrderStepFirst($bot)
    {
        $services = ParseService::getServices();
        $keyboard = KeyboardService::getInlineOrdersKeyboard($services);
        $bot->reply("Choose the social media ๐", $keyboard);
    }

    /**
     * ะะพะทะฒัะฐั ะฒ ะฝะฐัะฐะปัะฝะพะต ะผะตะฝั ัะฐะทะดะตะปะฐ ะทะฐะบะฐะทะพะฒ (ะฒัะฑะพั ัะพั.ัะตัะธ)
     * @param  BotMan $bot
     * @throws
     */
    public function handleOrderBackToStepFirst($bot)
    {
        $services = ParseService::getServices();
        $keyboard = KeyboardService::getInlineOrdersKeyboard($services);

        $parameters = array_merge([
            'chat_id' => $bot->getMessage()->getPayload()['chat']['id'],
            'message_id' => $bot->getMessage()->getPayload()['message_id'],
            'text' => "Choose the social media ๐",
        ], $keyboard);
        $bot->sendRequest('editMessageText', $parameters);
    }

    /**
     * ะัะฒะพะด ะบะฐัะตะณะพัะธะน ะดะปั ะทะฐะบะฐะทะฐ (ะฒัะฑะพั ััะปัะณะธ)
     * @param  BotMan $bot
     * @param $network
     * @throws
     */
    public function handleOrderStepSecond($bot, $network)
    {
        $services = ParseService::getServices();

        if(isset($services[$network])) $services = $services[$network];
        else $bot->reply('An error occurred. Try again.', $this->mainKeyboard);

        $keyboard = KeyboardService::getInlineOrdersKeyboard($services, $network);

        $parameters = array_merge([
            'chat_id' => $bot->getMessage()->getPayload()['chat']['id'],
            'message_id' => $bot->getMessage()->getPayload()['message_id'],
            'text' => "Choose the service ๐",
        ], $keyboard);
        $bot->sendRequest('editMessageText', $parameters);
    }

    /**
     * ะะฐะฟััะบ ะดะธะฐะปะพะณะฐ ะฝะฐ ัะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ
     * @param  BotMan $bot
     * @param $network /ัะพั ัะตัั
     * @param $service /ัะตัะฒะธั ัะพั ัะตัะธ
     * @throws
     */
    public function handleOrderStepThird($bot, $network, $service)
    {
        $services = ParseService::getServices();
        if(!isset($services[$network][$service])) $bot->reply('An error occurred. Try again.', $this->mainKeyboard);

        $user = $this->service->getOrRegisterUser($bot->getUser());
        $this->startConversation($bot, new CreateOrderConversation($user, $services[$network][$service]), 'Making order');
    }



    /**
     * ะัะฒะพะด ัะพะทะดะฐะฝะฝัั ะทะฐะบะฐะทะพะฒ
     * @param  BotMan $bot
     * @throws
     */
    public function handleOrderStat($bot)
    {
        $orders = $this->ordersService->getOrdersActive($bot->getUser()->getId());
        $bot->reply(
            "๐ฅ Your active orders: \r\n \r\n" . $orders,
            $this->ordersKeyboardActive + ['disable_web_page_preview' => 'true']
        );
    }


    /**
     * ะะพะธ ะทะฐะบะฐะทั: ะฝะฐะถะฐัะธั ะฟะพ ะบะฝะพะฟะบะฐะผ ะฟะพะด ะฟะพััะพะผ
     * @param BotMan $bot
     * @param $status /active || done
     */
    public function handleOrdersWithStatus($bot, $status = 'active')
    {
        $this->ordersService->getOrdersWithStatus($bot, $bot->getUser()->getId(), $status);
    }





    /**
     * ะะฐะณััะทะธั ะฝะตะพะฑัะพะดะธะผัะน ะดะธะฐะปะพะณ
     * @param  BotMan $bot
     * @param  $conversation
     * @param  $cancelButtonsText
     */
    public function startConversation(BotMan $bot, $conversation, $cancelButtonsText = false)
    {
        if ($cancelButtonsText) {
            $bot->reply($cancelButtonsText, $this->cancelKeyboard);
        }
        $bot->startConversation($conversation);
    }
}
